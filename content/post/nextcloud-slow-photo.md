+++
Categories = ["server"]
Description = "Как я поборол медленную загрузку фотографий в разделе Фото в Nextcloud"
Tags = ["linux", "self-hosted"]
date = "2024-01-11T21:40:14+03:00"
title = "Медленная работа раздела Фото в Nextcloud"
Banner = "/img/nextcloud-photo.jpg"
+++

Я уже несколько лет использую Nextcloud в качестве основного места хранения фотографий. Сначала я страдал от ооочень медленной загрузки фото в веб-интерфейсе и мобильном приложении. Решение этой проблемы очень простое.

<!--more-->
## Первичная генерация

В разделе Приложения своего Nextcloud-а я нашел дополнение [Preview Generator](https://github.com/nextcloud/previewgenerator). Это официальный плагин, который генерирует превью для всех фото в облаке. Потом, когда в веб-интерфейсе или в приложении на смартфоне вы будете просматривать фото, он не будет грузить многомегабайтный оригинал, а покажет это превью. Если скачать фото на диск, то скачается уже полный оригинал. 

Я установил плагин из веб-интерфейса, и, перед запуском процедуры генерации, обновил Nextcloud до последней версии. По субъективным ощущениям последняя версия работает шустрее.

Сначала надо запустить генерацию превьюшек для уже существующих фото. Я зашел в докер-контнейнер с nextcloud-ом и выполнил:

{{< highlight console>}}
./occ preview:generate-all --path="/admin/files/Фото"
{{< /highlight >}}

Указал, что хочу превьюшки только из папки Фото.

У меня 132 ГБ фотографий, и на одном ядре Intel Celeron J1900 весь процесс занял *несколько дней*, поэтому я запускал команду [внутри screen-а](/post/screen-cheatsheet/).

Сгенерированные файлы лежат в `<nextcloud_корень>/data/appdata_...`. У меня получилось **60 ГБ превьюшек**. 

## Регулярная задача

Для генерации превью новых фотографий, нужно добавить примерно такую cron-джобу:

{{< highlight console>}}
*/20 * * * root docker exec -u www-data -t nextcloud_app_1 ./occ preview:pre-generate
{{< /highlight >}}

Чтобы это всё работало, внутри nextcloud-а должен корректно работать [крон](https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/background_jobs_configuration.html). Для этого я тоже использую планировщик на сервере, и делаю обычный exec внутрь контейнера:

{{< highlight console>}}
*/5 * * * * root docker exec -u www-data -t nextcloud_app_1 php -f cron.php
{{< /highlight >}}

## Итог

Теперь раздел Фото в приложении и веб-интерфейсе по скорости работы сопоставим с Google Фото или Яндекс.Диском. 

Из минусов: 
* пока не смог сделать превью для видео. Вероятно, не хватает какого-то ffmpeg или еще чего-то. В интернете пишут, что превью для видеофайлов должны работать.
* пришлось заплатить шестьюдесятью гигами свободного места для превьюшек. И эта цена будет расти со временем


